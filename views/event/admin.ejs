<div id="deleteResult"></div>
<table class="table table-striped table-hover">
    <tbody>
    <% events.forEach( function(model) { %>
        <tr id="<%= model.id %>">
            <td><a href="/event/view/<%= model.id %>"><%= model.name %></a><button type="button" class="btn btn-danger" onclick="deleteEvent('<%= model.id %>')">Delete</button>
                <a href="/event/update/<%= model.id %>"><button type="button" class="btn btn-warning">Update</button></a>
                <% if (!registered == true) { %>
                    <br>
                    <button type="button" class="btn btn-primary
                    <% if (!event.quota == 0) { %>
                            " onclick="register(<%= req.session.idNum %>,<%= event.id %>,<%= event.quota %>)">
                            <% } else { %>
                            disabled">
                            <% } %>
                            Register</button>
            <% } else { %>
                    <br>
                    <button type="button" class="btn btn-danger" onclick="unregister(<%= req.session.idNum %>,<%= event.id %>,<%= event.quota %>)">Unregister</button>
                    <% }; %>
                    <% }; %>
        </tr>
    <% }); %>
</tbody>
</table>

<script>
async function deleteEvent(id) {
    console.log("id " + id);
var dr = document.getElementById("deleteResult");

var r = confirm("Confirm Delete?");
if (r == true) {
    var response = await fetch("/event/" + id, {
        method: "DELETE",
        credentials: 'same-origin',
    });

    console.log(response);
    
    if (response.status == 200) {
        document.getElementById(id).remove();
        var data = await response.text();
        dr.innerHTML = data;
    } else {
        dr.innerHTML = response.statusText;
    }

} else {
    dr.innerHTML = "cancelled";
}

};

async function register(user, event, quota) {

var r = confirm("Are you sure you would like to register?");
if (r == true) {
    var response = await fetch('/user/' + user + '/isRegistered/register/' + event, {
        method: "POST",
        credentials: 'same-origin',
    });
    
    if (response.status == 200) {
        await fetch('/event/' + event, {
        method: "POST",
        credentials: 'same-origin',
        body: JSON.stringify({'quota': quota - 1})
    });

    alert(await response.text());
    location.reload(true);

    } else {
        alert(await response.statusText);
    }

}
}

async function unregister(user, event, quota) {

var r = confirm("Are you sure you would like to unregister for this event?");
if (r == true) {
    var response = await fetch('/user/' + user + '/isRegistered/dereg/' + event, {
        method: "POST",
        credentials: 'same-origin',
    });
    
    if (response.status == 200) {
        await fetch('/event/' + event, {
        method: "POST",
        credentials: 'same-origin',
        body: JSON.stringify({'quota': quota + 1})
    });

    alert(await response.text());
    location.reload(true);

    } else {
        alert(await response.statusText);
    }

}</script>
